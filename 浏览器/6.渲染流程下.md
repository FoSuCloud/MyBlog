<!--
 * @Author: your name
 * @Date: 2020-10-27 23:50:38
 * @LastEditTime: 2021-03-04 00:36:07
 * @LastEditors: your name
 * @Description: In User Settings Edit
 * @FilePath: \MyHxsj\浏览器\6.渲染流程下.md
-->
## 渲染流程-下
* 在渲染流程上中，主要讲了创建DOM树、样式计算和布局三个阶段
* 接下来继续渲染流程

### 分层
* 在布局树创建完成，计算好每个DOM元素的位置信息之后，接下来还需要进行分层操作
* `因为页面中有很多复杂的效果，例如3D变换、页面滚动、z-index等`
* `为了方便实现这些效果，渲染引擎还会为特定的节点生成专用的图层，并生成一颗对应的图层树`
* 为了更好了解分层的改变，可以打开开发者工具，`点击...三个点找到more tools，找到layers，然后添加图层到工具栏`
* Layers可以对页面进行可视化分层，如图所示:

* `渲染引擎会给页面分成很多层，按照一定的顺序叠加在一起，组合成最终的页面，如图所示:`

* 通常情况下，并不是布局树的每个节点都包含一个图层，如果一个节点没有对应的层，那么这个节点就从属于父节点的图层。
* 就在上图中的两个span标签就没有专属图层，那么就从属于父节点的图层。

* `满足一下两点任意一个就可以被提升为单一的图层`
1. 具有层叠上下文属性的元素会被提升为单独的一层
* 层叠上下文属性指的不是z-index,z-index指的是堆叠顺序，层叠上下文属性有:position:relative/absolute/fixed;translate...
* 具体的可以看mdn: [https://developer.mozilla.org/zh-CN/docs/Web/CSS/CSS_Positioning/Understanding_z_index/The_stacking_context]
* z-index属性可以看: [https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Positioning/Understanding_z_index/Adding_z-index]
2. 需要被裁剪的部分也会被提升为单独一个层
* 就好像列表展示的数据太多，那么超过一定高度之后就会被overflow:hidden进行裁剪；
* 裁剪之后保留的部分就会被单独提升为一层；另外滚动条也会被单独提升为一层，而且滚动条层级更高一点

### 图层绘制
* 在完成图层树的构建之后，渲染引擎就可以根据图层树进行图层绘制了。图层的绘制需要根据绘制指令进行。
* 渲染引擎会把一个图层分成很多个绘制指令进行绘制。绘制一个元素通常不只需要一个指令。
* 例如背景色需要一个绘制指令，边框也需要一个绘制指令。所以在图层绘制阶段，输出的是待绘制列表。

### 栅格化操作
* 绘制列表实际上是用来记录绘制顺序和绘制指令的列表，实际上的绘制操作是由渲染引擎中的合成线程来完成的。
* 主线程和合成线程之间的关系如图所示：

* 当图层的绘制列表准备好之后，主线程会把绘制列表提交给合成线程
* 概念：
视口：屏幕上页面的可见区域(viewport)
* 页面可能很大，用户只能看到其中一个部分，我们把用户可以看到的这个部分称为视口
* 在某些情况下，有的图层可能很大，要滚动很久才能到底，但是通过视口，用户只能看到视口的这部分网页内容
* 如果在滚动到对应视口内容之前就把剩下所有内容都渲染好了再展示，那么就会产生太大的开销
`所以合成线程会把图层划分为一个个正方形图块`
* 然后合成线程就会根据视口附近的图块来优先生成位图，而实际的生成位图的操作是由栅格化来执行的
`栅格化就是把图块转换为位图`
`图块是栅格化的最小单位`
`渲染进程维护了一个栅格化的线程池。所有图块的栅格化都是在线程池中进行的`
* 通常栅格化都会使用GPU进行加速，使用GPU加速生成位图的过程称为`快速栅格化`，生成的位图被保存在GPU中
* 如果使用了GPU，那么就是跨进程操作，流程图所下所示：

### 合成和显示
* 一旦所有图块都被栅格化完成，那么合成线程就会发出一个绘制图块的命令`DrawQuad`
* 然后将该命令提交给浏览器进程。浏览器进程中的一个viz组件会接收合成线程发出的DrawQuad命令，然后根据命令把页面内容绘制到内存中
* 最后再将内存内容展示到屏幕上。然后就绘制完成了

### 整体渲染流程
1. 渲染进程将 HTML 内容转换为能够读懂的 DOM 树结构。
2. 渲染引擎将 CSS 样式表转化为浏览器可以理解的 styleSheets CSS层叠样式表，计算出 DOM 节点的样式。
3. 创建布局树，并计算元素的布局信息。
4. 对布局树进行分层，并生成分层树。
5. 为每个图层生成绘制列表，并将其提交到合成线程。
6. 合成线程将图层分成图块，并在光栅化线程池中将图块转换成位图。
7. 合成线程发送绘制图块命令 DrawQuad 给浏览器进程。浏览器进程根据 DrawQuad 消息生成页面，并显示到显示器上。
