## 输入URL到页面展示中间发生了什么
* 首先来看看从输入URL到页面展示完整流程示意图:

* 从图中可以看出，整个过程需要浏览器的各个进程之间的互相配合。
* 所以我们先来回顾一下浏览器主进程，网络进程，渲染进程的主要职责:
1. 浏览器进程主要负责用户交互，子进程管理和文件储存功能
2. 网络进程是面向渲染进程和浏览器进程提供网络下载功能的
3. 渲染进程的主要职责是把网络下载的HTML,JS,CSS,图片等资源解析为可以显示和交互的页面。
* 因为渲染进程中所有的内容都是通过网络获取的，所以可能会存在一些恶意代码。所以在渲染进程中的代码是不被信任的
* 这也是为什么Chrome浏览器让渲染进程运行在安全沙箱里，就是为了保证系统的安全。

### 过程
1. 首先浏览器进程接收到用户输入的URL请求，浏览器进程便将该URL转发给网络进程。
2. 然后在网络进程中发起真正的URL请求
3. 接着网络进程接受到了响应头数据，便解析响应头数据，将数据转发给浏览器进程。
4. 浏览器进程接收到网络进程的响应头数据后，发送"提交导航"信息给渲染进程
5. 渲染进程接收到"提交导航"消息之后，便开始准备接收HTML数据。
* `接收数据的方式是直接和网络进程建立数据管道`
6. 最后渲染进程向浏览器发送"确认提交"的消息，告诉浏览器已经准备好接收和解析页面数据了
7. 浏览器进程接收到渲染进程"提交文档"的消息之后，便开始移除之前旧的文档，然后更新浏览器进程中的页面状态。
 
`其中，用户发出URL请求到页面开始解析的过程就叫做导航`

### 导航过程

#### 1. 用户输入
* 用户在地址栏输入一个关键字，浏览器地址栏`会判断输入的关键字是搜索内容还是请求的URL`
* 如果是搜索内容，地址栏会使用浏览器默认的搜索引擎，来合成新的带搜索关键字的URL
* 如果判断输入内容符合URL规则，比如baidu.com;那么`地址栏会根据规则把内容加上协议合成完整的URL，如https://baidu.com`
    
* 当用户输入关键字并且键入回车之后，就意味着当前页面即将被替换成新的页面
* 不过在这个流程之前，浏览器还给了当前页面一次执行`beforeunload事件的机会`
* beforeunload事件允许页面在退出之前执行一些数据清理操作，还可以询问用户是否要离开当前页面
* 比如当前页面可能有还未提交完成的表单等情况，因此用户可以通过beforeunload事件来取消导航，让浏览器不再执行任何后续操作

`但是如果用户点击取消，那么浏览器就会进入加载状态，浏览器标签页的图标就成了加载中的旋转形式`
* 此时的页面显示的依然是之前的页面内容，并没有立刻替换成新的页面内容，`需要等到提交文档阶段，页面内容才会被替换`

#### 2.URL请求过程
* 此时进入了页面资源请求过程，浏览器进程会通过IPC把URL请求发送至网络进程
* 网络进程接收到URL请求后，会在这里发起真正的URL请求。
* URL具体请求流程是:
1. 首先，网络进程会查找本地缓存是否缓存了该资源。如果有缓存资源，那么直接返回资源给浏览器进程；
* 如果在缓存中没有找到资源，那么直接进入网络请求流程。
* 在网络请求前的第一步是要进程DNS解析，以获取请求域名的服务器IP地址。
* 如果请求协议是HTTPS，那么还需要建立TLS连接。
2. 接下来就是利用IP地址和服务器建立TCP连接。建立连接之后，浏览器端会构建请求行，请求头等信息。
* 并且把该域名相关的Cookie等数据附加到请求头上，然后向服务器发送构建的请求信息。
3. 服务器收到请求信息后，会根据请求信息生成响应数据，并发给网络进程。
* 等网络进程接收了响应行和响应头之后，就开始解析响应头的内容。

`其他情况`
1. 重定向
* 在接收到服务器返回的响应头后，网络进程开始解析响应头，如果发现返回的状态码是301或者302。
* 那么说明服务器需要浏览器重定向到其他URL。这时网络进程会从响应头的Location字段里面读取重定向的地址。
* 然后再发起新的HTTP/HTTPS请求。
* 服务器返回的响应头信息如下:

* `一种应用就是访问http://www.baidu.com,然后通过重定向访问到https协议下的网站`
* 就是使用HTTP协议向服务器发起请求时，服务器会返回一个包含301/302的状态码响应头
* 并且把响应头的Location字段填上HTTPS的地址，这就是告诉浏览器需要重新导航到新的地址上。
* 然后浏览器接收到响应头会使用Location字段的地址重新发起请求，然后得到状态码200就表示成功。

2. 响应数据类型处理
* Content-Type是HTTP头中一个非常重要的字段，它会告诉浏览器，服务器返回的数据是什么数据类型的。
* 以极客时间首页为例。如图所示:

* 其中text/html表示返回的是HTML格式的数据
* 然后去请求下载极客时间的安装包，返回的响应头为:

* 其中Content-Type的值是`application/octet-stream`
* 表示`返回的响应数据是字节流类型的`，通常情况下，浏览器会按照下载类型来处理该请求。
* 如果服务器配置的Content-Type不正确，比如将text/html配置成application/octet-stream类型
* 那么浏览器可能会曲解文件内容，比如将一个本来用来展示的页面变成了一个下载文件。
* 如果Content-Type字段的值被浏览器判断为下载类型，那么该请求会被提交给浏览器的下载管理器
* 同时该url请求的导航流程就到此结束。如果是html，那么浏览器会继续导航流程，然后准备运行渲染进程渲染页面

3. 准备渲染进程
* 默认情况下，Chrome会为每个页面分配一个渲染进程，也就是每打开一个新页面就会配套创建一个新的渲染进程。
* 但是`如果从一个页面打开了另一个新页面，并且新页面和当前页面属于同一站点的话，那么新页面会复用父页面的渲染进程，进程的ID一致`
* 同一站点指的是`协议相同，根域名相同`，比如下面三个域名:
```
https://time.geekbang.org
https://www.geekbang.org
https://www.geekbang.org:8080
```
* `都是属于同一站点，因为协议都是https协议，根域名都是geekbang.org`
    
* 如果新页面和当前页面不属于同一站点，例如在极客邦打开InfoQ的官网，因为属于不同站点，所以infoQ会使用新的渲染进程
* 如图所示:

* 当我们根据Content-Type:text/html准备渲染进程，准备好之后，`还不能进入文档解析状态`
* 因为`此时的文档数据还在网络进程中，发送过来的只是响应头，文档还没有提交给渲染进程，所以下一步就进入提交文档阶段`

4. 提交文档
* 所谓的提交文档就是指浏览器进程将网络进程接收到的html数据提交给渲染进程。具体流程是:
4.1 首先当浏览器进程接收到网络进程的响应头数据之后，便向渲染进程发起"提交文档"的消息；
4.2 渲染进程接收到"提交文档"的消息之后，会和网络进程建立传输数据的管道
4.3 当文档数据传输完成之后，渲染进程会返回"确认提交"的消息给浏览器进程
4.4 当浏览器进程在收到"确认提交"的消息之后，会更新浏览器界面状态，包括安全状态、地址栏的URL、前进后退的历史状态、并更新Web页面。
* 更新内容如下图所示:

5. 渲染阶段
* 一旦文档被提交，渲染进程便开始页面解析和子资源加载了
* 一旦页面生成完成，渲染进程会发送一个消息给浏览器进程，浏览器接收到消息后
* 会停止标签图标上的加载动画。




