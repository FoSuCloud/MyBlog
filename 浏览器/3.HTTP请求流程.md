
## HTTP请求流程
* 在介绍HTTP请求流程之前，需要先了解HTTP协议。
* HTTP协议就是建立在TCP连接基础上的。HTTp是一种允许浏览器向服务器获取资源的协议，是Web的基础。
* 通常由浏览器发起HTTP请求，用来获取不同类型的文件，例如HTML,CSS,js,图片，视频等。
* `同时HTTP也是浏览器使用最广的协议。`

### 浏览器端发起HTTP请求的流程
* 如果在浏览器地址栏输入www.baidu.com,浏览器会完成哪些动作？

#### 1. 构建请求行
* 首先，浏览器会构建请求行信息，构建好之后，浏览器才会准备发起网络请求。
`GET /index.html HTTP1.1`

#### 2. 查找缓存
* 在真正发起网络请求之前，浏览器会先在浏览器缓存中查询是否存在当前要请求的文件。
* `浏览器缓存是一种在本地保存资源副本，以供下次请求时直接使用的技术`
* 当浏览器发现需要请求的资源在浏览器缓存中存在，那么会拦截请求，返回浏览器缓存中的副本，并且结束HTTP请求，而不会再去服务器端请求。
* 浏览器缓存副本的好处有:
1. 缓解服务器端压力，提升性能
2. 对于客户端网站来说，能够提升资源加载的速度，因为不需要等待服务器返回资源

#### 3. 准备IP地址和端口
* 因为浏览器使用HTTP协议作为应用层协议，`用来封装请求的文本信息`；
* 并且使用TCP/IP协议作为传输层协议发送到网络上。
* 所以在HTTP协议工作之前，需要先通过TCP协议与服务器建立连接。
* 也就是`HTTP协议发起请求是在TCP协议的数据传输阶段进行的`
* TCP和HTTP协议的关系如图所示:

* 但是我们发起TCP连接之前需要准备IP地址和端口，然后才能找到对应服务器和应用程序
* 由于我们在浏览器地址栏输入的一般都是网站域名，所以得不到对应的IP地址
* 为了`通过域名解析得到对应的网络IP地址，设计了域名解析系统DNS(Domain Name System)`
* 所以发起TCP请求之前应该先通过DNS系统获取对应的IP地址，但是浏览器还提供了DNS缓存服务，如果某个域名已经解析过，那么就会在浏览器保存解析后的结果
* TCP连接所需要的端口号可以通过url获取，一般来说HTTP请求默认是80端口，HTTPS请求默认是443端口

#### 4. 等待TCP队列
* 既然发起TCP连接的前置条件:IP地址和端口已经准备好了，那么是不是可以直接发起TCP连接了呢？
* 其实还可能需要排队。因为Chrome浏览器存在一个机制，用一个域名下同时最多只能建立6个TCP连接。
* 例如baidu域名下有10个请求同时发生，那么有4个请求就要进入排队等待状态，直至请求完成。

#### 5. 建立TCP连接
* 在TCP排队等待结束后，就可以开始和服务器建立TCP连接了。

#### 6. 发起HTTP请求
* 一旦建立了TCP连接，浏览器就可以和服务器建立通信了
* HTTP中的数据就是在TCP连接的数据传输阶段进行传输的
* HTTP请求的数据格式分为:请求行，请求头，请求体，如图所示:

1. 发送请求行，就是告诉服务器，浏览器需要什么资源。
2. 在浏览器发送请求行命令之后，还要以请求头的形式发送一些其他信息，例如域名，浏览器内核等信息。
3. 如果请求方法是POST方法，那么需要发送数据给服务器，这些数据就放在请求体中发送

### 服务器处理HTTP请求流程
#### 1. 返回请求
* 一旦服务器处理完毕数据，就可以返回给浏览器了。
* 服务器响应的数据格式如下所示:

1. 首先服务器会返回响应行，包括HTTP协议版本和状态码
2. 随后服务器会发送响应头。响应头包含了服务器自身的一些信息，包括数据返回时间，数据类型等
3. 发送完响应头之后，服务器就可以继续发送响应体的数据。

#### 2.断开连接
* 通常情况下，一旦服务器向浏览器返回了数据，那么就会关闭TCP连接。
* 除非`服务器或者浏览器在头部信息中加入了`
`Connection:Keep-Alive`
* 如果能够保持TCP连接的打开状态，那么浏览器就可以持续通过同一个TCPL连接发送请求
* `就能够节省建立TCP连接所需要花费的时间，提升资源加载速度`

#### 3. 重定向
* 还要注意重定向问题。
* 在浏览器地址栏输入`geekbang.org，会发现打开的是https://www.geekbang.org`
* 这两个url之所以会不一样就是因为涉及到了一个重定向操作。
* 重定向返回的数据形式如下所示:

* 301状态码表示永久重定向，也就是在地址栏输入geekbang.org,永远会导航到https://www.geekbang.org
* 而重定向的网站正式需要包含在响应头的Location字段中
* `而浏览器会获取Location字段中的地址，并使用该地址重新导航！`
* `而且重定向不是必然的，需要后端设置，例如输入12306.cn就不会重定向到https://www.12306.cn`

### 为什么很多站点第二次打开速度很快？
* 因为第一次加载的时候会缓存一些耗时的数据
* 那么哪些数据会被缓存呢？主要是`DNS缓存和页面资源缓存`
* 下面是浏览器资源缓存处理的过程:

1. 当服务器返回HTTP响应头给浏览器时，浏览器是通过响应头中的Cache-Control字段来设置是否缓存该资源
2. 通常还需要为这个字段设置一个缓存过期时长，而这个时长是通过Cache-Control中的Max-age参数来设置
`Cache-Control:Max-age=2000就是设置了缓存过期时间为2000秒`
* 也就是在缓存资源还未过期的情况下，如果再次请求资源会直接返回缓存中的资源给浏览器
* 并且浏览器会在Cache-Control字段维护一个Age参数，也就是资源到现在的时间来判断是否过期
3. 如果缓存过期了，那么浏览器会继续发起请求，并且在HTTP请求头带上
`If-None-Match:'sdaad768432'`
* `服务器通过If-None-Match来判断该资源是否有更新`
* 如果没有更新就返回304状态码，等于告诉浏览器可以继续使用缓存的这个资源，这次不会发送重复数据给浏览器
* 如果资源有更新，那么浏览器会返回最新资源给浏览器
* `注意:有没有更新都会重置Cache-Control字段的参数当前资源的存在时间Age为0`

### 登录状态怎么保持？
1. 用户打开登录页面填写信息，点击确定触发事件，调用POST方法提交登录信息给服务器
2. 服务器接收到浏览器提交的信息之后，查询后端验证信息正确性，如果正确会返回一段表示用户身份的字符串
* 并`把字符串写到响应头的Set-Cookie字段里`，返回把响应头发送给浏览器
`Set-Cookie:UID=2132135324uds;`
3. 浏览器在接收到服务器的响应头后，开始解析响应头，如果遇到响应头里面含有Set-Cookie字段的情况
* 浏览器就会把字段信息保存到本地
4. 当用户再次访问该网站的时候，浏览器就会发起HTTP请求，但在发起请求之前，浏览器会读取之前保存的Cookie数据
* 并且把数据写进请求头里面的Cookie字段里，然后浏览器再把请求头发送给服务器
`Cookie:UID=323asa;`
5. 服务器在收到HTTP请求头数据后，就会查找请求头里面的Cookie字段信息，当查找到包含UID=323asa的信息时，
6. 服务器会查询后台，判断该用户是否已经是登录状态，然后生成包含有该用户信息的页面数据，就可以把生成的数据发送给浏览器
7. 浏览器在接收到含有该用户的页面数据后就可以正确展示用户登录状态信息了
* Cookie实现流程可以参考下图:

* `最后，HTTP请求流程示意图如下所示:`

