## 流
* 流是一个包含零个或者任意多个流元素的有序队列，队列中的每个元素都包含一个ID和任意多个键值对
* 这些元素会根据ID的大小在六种有序地进行排列

* 例子
* 一个记录用户访问轨迹的流visits,这个流包含了ID,用户名称、停留时长等
* 1、ID为110000000000、name为A、duration为150
* 2、ID为120000000000、name为B、duration为200
* 3、ID为130000000000、name为C、duration为100

#### 添加元素到流的末尾
* `XADD：追加新元素到流的末尾`,用户可以通过执行XADD命令，将一个带有指定ID以及包含指定键值对的元素追加到流的末尾
* `XADD stream id field value [field value ...]`

* `如果给定的流不存在，那么redis会县创建一个空白的流，然后将给定的元素追加到流中`

* 流中的每个元素可以包含一个或任意多个键值对，并且同一个流中的不同元素可以包含不同数量的键值对，
* 比如其中一个元素可以包含3个键值对，而另一个元素则可以包含5个键值对，诸如此类。
* 需要注意的是，与散列以无序方式存储键值对的做法不同，`流元素会以有序方式存储用户给定的键值对`：
* `用户在创建元素时以什么顺序给定键值对，它们在被取出的时候就是什么顺序。`

#### 流元素的ID
*` 流元素的ID由毫秒时间（millisecond）和顺序编号（sequcen number）两部分组成，`
* 其中使用UNIX时间戳表示的毫秒时间用于标识与元素相关联的时间，而以0为起始值的顺序编号则用于区分同一时间内产生的多个不同元素。
* 因为毫秒时间和顺序编号都使用64位的非负整数表示，所以整个流ID的总长为128位，
* 而Redis在接受流ID输入以及展示流ID的时候都会使用连字符-分割这两个部分。

* 例子：在这个示例中，元素ID的毫秒时间部分为1100000000000，而顺序编号部分则为12345。
* 如果我们使用这个ID作为输入调用以下XADD命令，那么Redis将把包含键值对k1和v1的新元素追加到流s1的末尾：
```redis
127.0.0.1:6379>xadd temp-stream 110000000000-12345 k1 v1
"110000000000-12345"
```
XADD命令在成功执行时将返回新元素的ID作为结果。在这个例子中，被返回的ID就是我们刚刚输入的ID。

#### 不完整的流ID
* 用户在输入流ID的时候，除了可以给出带有毫秒时间和顺序编号的完整流ID之外，
* 还可以给出只包含毫秒时间的不完整流ID：`在这种情况下，Redis会自动将ID的顺序编号部分设置为0。`


```redis
127.0.0.1:6379> xadd temp-stream 12000000000 k1 v1
(error) ERR The ID specified in XADD is equal or smaller than the target stream top item
127.0.0.1:6379> xadd temp-stream 120000000000 k1 v1
"120000000000-0"
```
* `注意：新条目的ID必须大于之前插入的条目的ID。`

#### 流元素ID的限制
* 因为同一个流中的每个元素ID都用于指定特定的一个元素，所以这些ID必须是各不相同的，
* `换句话说，同一个流中的不同元素(注意是不同元素)是不允许使用相同ID的。`
```redis
127.0.0.1:6379> xadd temp-stream 1200000000000 k2 vv
(error) ERR The ID specified in XADD is equal or smaller than the target stream top item
```
* 除了不允许使用相同的ID之外，Redis还要求新元素的ID必须比流中所有已有元素的ID都要大。具体来说，Redis会记住每个流已有元素的最大ID，
* 并在用户尝试向流里面添加新元素的时候，使用新元素的ID与流目前最大的ID进行对比：
  ●如果新ID的毫秒时间部分比最大ID的`毫秒时间部分要大，那么允许添加新元素`。
* ●如果新ID的毫秒时间部分与最大ID的毫秒时间部分相同，那么对比两个ID的顺序编号部分，
* `如果新ID的顺序编号部分比最大ID的顺序编号部分要大，那么允许添加新元素。`

* 在执行上述命令之后，流s1的最大元素ID就从原来的110000000000-12345更新到了1200000000000-0。

#### 只执行追加操作的流
* 通过将元素ID与时间进行关联，并强制要求新元素的ID必须大于旧元素的ID,Redis从逻辑上`将流变成了一种只执行追加操作（append only）的数据结构`，
* 这种特性对于使用流实现消息队列和事件系统的用户来说是非常重要的：用户可以确信，`新的消息和事件只会出现在已有消息和事件之后`，
* 就像现实世界里新事件总是发生在已有事件之后一样，一切都是有序进行的。
* 此外，只能`将新元素添加到末尾而不允许在数据结构的“中间”添加新元素`，这也是流与列表以及有序集合之间的一个显著区别。

#### 自动生成元素ID
* Redis流对元素ID的要求非常严格，并且还会拒绝不符合规则的ID。为了方便用户执行添加操作，Redis为XADD命令的id参数设定了一个特殊值＊：
* `当用户将符号＊用作id参数的值时，Redis将自动为新添加的元素生成一个可用的新ID。`

* 自动生成的新ID会将Redis所在宿主机器当前毫秒格式的UNIX时间戳用作ID的毫秒时间，并根据当前已有ID的最大顺序编号来设置新ID的顺序编号部分：
```redis
127.0.0.1:6379> xadd temp-stream * k1 v1
"1688222738132-0"
```

* `如前所述，如果我们在同一毫秒内同时执行多个XADD命令，那么新ID还会带有相同的毫秒时间以及不同的顺序编号：`
```redis
        redis> XADD s1 ＊ k2 v2
1530514186159-0

redis> XADD s1 ＊ k3 v3
1530514186159-1

redis> XADD s1 ＊ k4 v4
1530514186159-2
```

#### 限制流的长度
* XADD命令还提供了MAXLEN选项，让用户可以在添加新元素的同时删除旧元素，以此来限制流的长度：
* 在将新元素追加到流的末尾之后，XADD命令就会按照MAXLEN选项指定的长度，按照先进先出规则移除超出长度限制的元素。



