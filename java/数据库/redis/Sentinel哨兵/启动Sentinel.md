## 启动Sentinel
* Redis Sentinel的程序文件名为redis-sentinel，它通常和`普通Redis服务器redis-server`位于同一个文件夹。
* 因为用户需要在配置文件中`指定`想要被Sentinel监视的`主服务器`，
* 并且Sentinel也`需要在配置文件中写入信息以记录主从服务器的状态`，
* 所以用户在启动Sentinel的时候`必须传入一个可写的配置文件作为参数`，就像这样：
`        $ redis-sentinel /etc/sentinel.conf`

#### sentinel.conf
* 一个Sentinel配置文件至少需要包含以下选项，用于指定Sentinel要监视的主服务器：
`        sentinel monitor <master-name> <ip> <port> <quorum>`
* 选项中的master-name参数用于指定主服务器的名字，这个名字在执行各种Sentinel操作的时候会经常用到；
* ip参数和port参数用于指定主服务器的IP地址和端口号；而quorum参数则用于指定判断这个主服务器下线所需的Sentinel数量。

* 如果我们要监视主服务器127.0.0.1:6379，并在Sentinel中将它命名为website_db，
* 那么可以在配置文件sentinel.conf里面包含以下选项：
`        sentinel monitor website_db 127.0.0.16379 1`
因为我们目前只启动了一个Sentinel，所以quorum参数的值被设置成了1。
* 也就是说，只要`有一个Sentinel认为website_db主服务器下线了`，Sentinel就可以对website_db`实施故障转移`了。

* Sentinel首先监视了我们指定的主服务器127.0.0.1:6379，
* 然后又`自动发现并监视了`它的两个`从服务器`127.0.0.1:6380和127.0.0.1:6381。

* 因为Sentinel开始监视一个主服务器之后，就会去获取被监视主服务器的`从服务器名单`，并根据名单对各个从服务器实施监视，
* 整个过程是完全`自动`的，所以用户只需要`输入待监视主服务器的地址`就可以了，并不需要输入从服务器的地址。
* 除此之外，Sentinel还会对每个被监视的主从服务器实施心跳检测，并记录各个服务器的在线状态、响应速度等信息，
* 当Sentinel发现被监视的主服务器进入下线状态时，它就会开始`对下线的主服务器实施故障转移`。

* 举个例子，如果我们故意杀死主服务器6379，那么Sentinel将检测到6379已下线，
* 并从6380和6381这两个从服务器之间选出一个新的主服务器，然后重新构建一个主从服务器连接。

#### redis-sentinel和redis-server之间的关系
* Redis Sentinel实际上就是一个运行在特殊模式下的Redis服务器，所以用户也可以使用命令
* `redis-server sentinel.conf --sentinel`去启动一个Sentinel：
* 这里的--sentinel参数用于指示Redis服务器进入Sentinel模式，从而变成一个Redis Sentinel而不是普通的Redis服务器。

#### 同时监视多个主服务器
* `一个Sentinel可以监视任意数量的主服务器`，而不是仅仅监视一个主服务器。
* 如果用户想要使用Sentinel去监视多个主服务器，那么只需要在配置文件中`指定多个sentinel monitor选项`，
* 并为每个被监视的主服务器设置不同的名字即可，例如：
```text
sentinel monitor website_db 127.0.0.16379 1
sentinel monitor api_db 192.168.0.56379 1
sentinel monitor background_job_db 192.168.0.1016379 1
```

#### 处理重新上线的旧主服务器
* Sentinel在对下线的主服务器实施故障转移之后，仍然会继续对它进行心跳检测，
* 当这个服务器重新上线的时候，Sentinel将把它`转换为当前主服务器的从服务器`。

#### 设置从服务器优先级
* 用户可以通过replica-priority配置选项来设置各个从服务器的优先级，优先级较高的从服务器在Sentinel选择新主服务器的时候会优先被选择。
* `replica-priority的默认值为100`，这个值`越小`，从服务器的优先级就`越高`。
* 举个例子，如果现在有3个从服务器，它们的优先级分别为100、50和10，
* 那么Sentinel将优先选用优先级为10的从服务器作为新的主服务器。
* 通过这个配置选项，用户可以给性能较高的从服务器设置较高的优先级来尽可能地保证新主服务器的性能。
* 因为主服务器在下线并重新上线之后也会变成从服务器，所以用户也应该为主服务器设置相应的优先级。
* `replica-priority值为0的从服务器永远不会被选为主服务器`，
* 用户可以通过这一设置将不适合用作主服务器的从服务器排除在新主服务器的候选名单之外。

#### 新主服务器的挑选规则
当Sentinel需要在多个从服务器中选择一个作为新的主服务器时，首先会根据以下规则从候选名单中剔除不符合条件的从服务器：
1）否决所有已经下线以及长时间没有回复心跳检测的疑似已下线从服务器。
2）否决所有长时间没有与主服务器通信，数据状态过时的从服务器。
3）否决所有优先级为0的从服务器。

然后根据以下规则，在剩余的候选从服务器中选出新的主服务器：
1）优先级最高的从服务器获胜。
2）如果优先级最高的从服务器有两个或以上，那么复制偏移量最大的那个从服务器获胜。
3）如果符合上述两个条件的从服务器有两个或以上，那么选出它们当中运行ID
（运行ID是服务器启动时自动生成的随机ID，这条规则可以确保条件完全相同的多个从服务器最终得到一个有序的比较结果）最小的那一个。


